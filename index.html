<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLA Angle Calculator</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="vendor/pico.min.css">
    <link rel="stylesheet" href="css/app.css">
    <script defer src="js/app.js"></script>
    <script defer src="vendor/alpine.min.js"></script>
</head>
<body>
    <a href="#results-section" class="skip-link">Skip to results</a>
    <main class="container" x-data="calculator" x-cloak>
        <header>
            <h1>SLA Angle Calculator</h1>
            <p>Based on the original calculator by RC87</p>
        </header>

        <section class="printer-selector-row">
            <div class="printer-selector">
                <label for="printer-search">Select Printer</label>
                <div class="printer-input-row">
                <div class="dropdown-wrapper">
                <input
                    id="printer-search"
                    type="text"
                    x-model="searchQuery"
                    @focus="openDropdown()"
                    @blur.debounce.200ms="closeDropdown()"
                    @keydown="handleKeydown($event)"
                    @input="resetHighlightOnSearch()"
                    :placeholder="selectedPrinter ? '' : 'Search printers...'"
                    :value="selectedPrinter && !dropdownOpen ? selectedPrinter.manufacturer + ' ' + selectedPrinter.model : searchQuery"
                    autocomplete="off"
                    role="combobox"
                    aria-haspopup="listbox"
                    :aria-expanded="dropdownOpen"
                    aria-controls="printer-listbox"
                    aria-autocomplete="list"
                    :aria-activedescendant="dropdownOpen && allDropdownItems[highlightedIndex] ? 'printer-option-' + allDropdownItems[highlightedIndex].id : null"
                />
                <ul x-show="dropdownOpen" x-cloak x-ref="dropdownList" id="printer-listbox" role="listbox" class="dropdown-list">
                    <template x-if="loading">
                        <li class="dropdown-item loading-skeleton" role="option" aria-label="Loading printers">
                            <div class="skeleton-items" aria-hidden="true">
                                <div class="skeleton-item">
                                    <span class="skeleton skeleton-name"></span>
                                    <span class="skeleton skeleton-pixel"></span>
                                </div>
                                <div class="skeleton-item">
                                    <span class="skeleton skeleton-name"></span>
                                    <span class="skeleton skeleton-pixel"></span>
                                </div>
                                <div class="skeleton-item">
                                    <span class="skeleton skeleton-name"></span>
                                    <span class="skeleton skeleton-pixel"></span>
                                </div>
                            </div>
                            <span class="visually-hidden">Loading printers...</span>
                        </li>
                    </template>
                    <template x-if="jsonError">
                        <li class="dropdown-item error" role="option">
                            <span x-text="jsonError"></span>
                            <button
                                class="retry-btn"
                                @mousedown.prevent.stop="loadPrinters()"
                                aria-label="Retry loading printers"
                            >Retry</button>
                        </li>
                    </template>
                    <template x-if="!loading && !jsonError && filteredPrinters.length === 0 && filteredFavorites.length === 0">
                        <li class="dropdown-item empty" role="option">No printers found</li>
                    </template>

                    <!-- Favorites Section -->
                    <template x-if="!loading && !jsonError && filteredFavorites.length > 0">
                        <li class="dropdown-section-header" role="presentation">Favorites</li>
                    </template>
                    <template x-for="(printer, index) in filteredFavorites" :key="'fav-' + printer.id">
                        <li
                            :id="'printer-option-' + printer.id"
                            class="dropdown-item favorite"
                            :class="{ 'highlighted': index === highlightedIndex }"
                            @mousedown.prevent="selectPrinter(printer)"
                            @mouseenter="highlightedIndex = index"
                            role="option"
                            :aria-selected="index === highlightedIndex"
                        >
                            <button
                                class="star-btn"
                                @mousedown.stop="toggleFavorite(printer.id)"
                                aria-label="Remove from favorites"
                            >★</button>
                            <span class="printer-name" x-text="printer.manufacturer + ' ' + printer.model"></span>
                            <span class="pixel-info" x-text="printer.pixelX === printer.pixelY ? printer.pixelX + 'μm' : printer.pixelX + '×' + printer.pixelY + 'μm'"></span>
                        </li>
                    </template>

                    <!-- All Printers Section -->
                    <template x-if="!loading && !jsonError && filteredFavorites.length > 0 && filteredNonFavorites.length > 0">
                        <li class="dropdown-section-header" role="presentation">All Printers</li>
                    </template>
                    <template x-for="(printer, index) in filteredNonFavorites" :key="printer.id">
                        <li
                            :id="'printer-option-' + printer.id"
                            class="dropdown-item"
                            :class="{ 'highlighted': (filteredFavorites.length + index) === highlightedIndex }"
                            @mousedown.prevent="selectPrinter(printer)"
                            @mouseenter="highlightedIndex = filteredFavorites.length + index"
                            role="option"
                            :aria-selected="(filteredFavorites.length + index) === highlightedIndex"
                        >
                            <button
                                class="star-btn"
                                @mousedown.stop="toggleFavorite(printer.id)"
                                :aria-label="isFavorite(printer.id) ? 'Remove from favorites' : 'Add to favorites'"
                            >☆</button>
                            <span class="printer-name" x-text="printer.manufacturer + ' ' + printer.model"></span>
                            <span class="pixel-info" x-text="printer.pixelX === printer.pixelY ? printer.pixelX + 'μm' : printer.pixelX + '×' + printer.pixelY + 'μm'"></span>
                        </li>
                    </template>
                </ul>
                </div>
                <button
                    x-show="selectedPrinter"
                    @click="showPrinterModal = true"
                    class="info-btn"
                    type="button"
                    aria-label="Show printer details"
                    title="Printer details"
                >ℹ</button>
                </div>
            </div>
            <div class="layer-height-control">
                <label for="layer-height">Layer Height (μm)</label>
                <input
                    id="layer-height"
                    type="number"
                    x-model.number="layerHeight"
                    min="10"
                    max="200"
                    step="1"
                    :aria-invalid="validationErrors.layerHeight ? 'true' : 'false'"
                    :aria-describedby="validationErrors.layerHeight ? 'error-layer-height' : null"
                    :class="{ 'error': validationErrors.layerHeight }"
                />
                <span
                    id="error-layer-height"
                    class="error-message"
                    x-show="validationErrors.layerHeight"
                    x-text="validationErrors.layerHeight"
                    role="alert"
                ></span>
            </div>
        </section>

        <section class="manual-input" x-show="!selectedPrinter">
            <p class="hint">Or enter pixel size manually:</p>
            <div class="manual-fields">
                <div class="field">
                    <label for="manual-pixel-x">Pixel X (μm)</label>
                    <input
                        id="manual-pixel-x"
                        type="number"
                        x-model.number="manualPixelX"
                        min="1"
                        max="200"
                        step="0.1"
                        :aria-invalid="validationErrors.manualPixelX ? 'true' : 'false'"
                        :aria-describedby="validationErrors.manualPixelX ? 'error-pixel-x' : null"
                        :class="{ 'error': validationErrors.manualPixelX }"
                    />
                    <span
                        id="error-pixel-x"
                        class="error-message"
                        x-show="validationErrors.manualPixelX"
                        x-text="validationErrors.manualPixelX"
                        role="alert"
                    ></span>
                </div>
                <div class="field">
                    <label for="manual-pixel-y">Pixel Y (μm)</label>
                    <input
                        id="manual-pixel-y"
                        type="number"
                        x-model.number="manualPixelY"
                        min="1"
                        max="200"
                        step="0.1"
                        :aria-invalid="validationErrors.manualPixelY ? 'true' : 'false'"
                        :aria-describedby="validationErrors.manualPixelY ? 'error-pixel-y' : null"
                        :class="{ 'error': validationErrors.manualPixelY }"
                    />
                    <span
                        id="error-pixel-y"
                        class="error-message"
                        x-show="validationErrors.manualPixelY"
                        x-text="validationErrors.manualPixelY"
                        role="alert"
                    ></span>
                </div>
            </div>
        </section>

        <section id="results-section" class="results" x-show="canShowResults" role="region" aria-labelledby="results-heading">
            <h2 id="results-heading">Calculated Angle<span x-show="!hasSquarePixels">s</span></h2>

            <!-- Square pixels: single angle -->
            <template x-if="hasSquarePixels">
                <div class="angle-display single" aria-live="polite">
                    <span class="angle-label" x-text="'Angle (' + currentPixelX + 'μm)'"></span>
                    <div class="angle-row">
                        <span class="angle-value" x-text="angleX?.toFixed(2) ?? '--'"></span>
                        <span class="angle-unit">°</span>
                    </div>
                    <span class="complementary-angle" x-text="(complementaryAngleX?.toFixed(2) ?? '--') + '°'"></span>
                </div>
            </template>

            <!-- Non-square pixels: two angles -->
            <template x-if="!hasSquarePixels">
                <div class="angle-display dual" aria-live="polite">
                    <div class="angle-column">
                        <span class="angle-label" x-text="'X Angle (' + currentPixelX + 'μm)'"></span>
                        <div class="angle-row">
                            <span class="angle-value" x-text="angleX?.toFixed(2) ?? '--'"></span>
                            <span class="angle-unit">°</span>
                        </div>
                        <span class="complementary-angle" x-text="(complementaryAngleX?.toFixed(2) ?? '--') + '°'"></span>
                    </div>
                    <div class="angle-column">
                        <span class="angle-label" x-text="'Y Angle (' + currentPixelY + 'μm)'"></span>
                        <div class="angle-row">
                            <span class="angle-value" x-text="angleY?.toFixed(2) ?? '--'"></span>
                            <span class="angle-unit">°</span>
                        </div>
                        <span class="complementary-angle" x-text="(complementaryAngleY?.toFixed(2) ?? '--') + '°'"></span>
                    </div>
                </div>
            </template>

            <!-- Angle Diagram - 2D tilted rectangles matching RC87 reference -->
            <svg
                class="angle-diagram"
                viewBox="0 0 600 280"
                role="img"
                aria-labelledby="diagram-title diagram-desc"
            >
                <title id="diagram-title">Angle Diagram</title>
                <desc id="diagram-desc" x-text="hasSquarePixels ? 'Visual representation of ' + (angleX?.toFixed(1) ?? '--') + '° tilt angle' : 'Visual representation showing X angle ' + (angleX?.toFixed(1) ?? '--') + '° and Y angle ' + (angleY?.toFixed(1) ?? '--') + '°'">Visual representation of tilt angles</desc>

                <!-- Build plate (dark bar at bottom) -->
                <rect :x="hasSquarePixels ? 30 : 20" y="240" :width="hasSquarePixels ? 390 : 560" height="20" class="build-plate" />

                <!-- SQUARE PIXELS: Single centered block -->
                <g x-show="hasSquarePixels">
                    <!-- Tilted rectangle (gray fill) -->
                    <polygon :points="singleBlockData.rect.points" class="tilted-block" />
                    <!-- Green left edge -->
                    <line
                        :x1="singleBlockData.rect.leftEdge.x1"
                        :y1="singleBlockData.rect.leftEdge.y1"
                        :x2="singleBlockData.rect.leftEdge.x2"
                        :y2="singleBlockData.rect.leftEdge.y2"
                        class="block-left-edge"
                    />

                    <!-- Vertical reference line -->
                    <line
                        :x1="singleBlockData.vertLine.x1"
                        :y1="singleBlockData.vertLine.y1"
                        :x2="singleBlockData.vertLine.x2"
                        :y2="singleBlockData.vertLine.y2"
                        class="vertical-reference-line"
                    />

                    <!-- Single arc from vertical to horizontal -->
                    <path :d="singleBlockData.arcPath" class="angle-arc" />
                    <text
                        :x="singleBlockData.arc1LabelPos.x"
                        :y="singleBlockData.arc1LabelPos.y"
                        class="angle-label"
                        x-text="(angleX?.toFixed(4) ?? '--') + '°'"
                    ></text>
                    <text
                        :x="singleBlockData.arc2LabelPos.x"
                        :y="singleBlockData.arc2LabelPos.y"
                        class="angle-label-complement"
                        x-text="(complementaryAngleX?.toFixed(4) ?? '--') + '°'"
                    ></text>
                </g>

                <!-- NON-SQUARE PIXELS: Two blocks side by side -->
                <g x-show="!hasSquarePixels">
                    <!-- X Block (left side) -->
                    <g class="x-block-group">
                        <polygon :points="xBlockData.rect.points" class="tilted-block" />
                        <line
                            :x1="xBlockData.rect.leftEdge.x1"
                            :y1="xBlockData.rect.leftEdge.y1"
                            :x2="xBlockData.rect.leftEdge.x2"
                            :y2="xBlockData.rect.leftEdge.y2"
                            class="block-left-edge"
                        />

                        <!-- Vertical reference line -->
                        <line
                            :x1="xBlockData.vertLine.x1"
                            :y1="xBlockData.vertLine.y1"
                            :x2="xBlockData.vertLine.x2"
                            :y2="xBlockData.vertLine.y2"
                            class="vertical-reference-line"
                        />

                        <!-- Single arc from vertical to horizontal -->
                        <path :d="xBlockData.arcPath" class="angle-arc" />
                        <text
                            :x="xBlockData.arc1LabelPos.x"
                            :y="xBlockData.arc1LabelPos.y"
                            class="angle-label"
                            x-text="(angleX?.toFixed(4) ?? '--') + '°'"
                        ></text>
                        <text
                            :x="xBlockData.arc2LabelPos.x"
                            :y="xBlockData.arc2LabelPos.y"
                            class="angle-label-complement"
                            x-text="(complementaryAngleX?.toFixed(4) ?? '--') + '°'"
                        ></text>

                        <!-- X Label -->
                        <text x="140" y="270" class="block-axis-label">X</text>
                    </g>

                    <!-- Y Block (right side) -->
                    <g class="y-block-group">
                        <polygon :points="yBlockData.rect.points" class="tilted-block" />
                        <line
                            :x1="yBlockData.rect.leftEdge.x1"
                            :y1="yBlockData.rect.leftEdge.y1"
                            :x2="yBlockData.rect.leftEdge.x2"
                            :y2="yBlockData.rect.leftEdge.y2"
                            class="block-left-edge"
                        />

                        <!-- Vertical reference line -->
                        <line
                            :x1="yBlockData.vertLine.x1"
                            :y1="yBlockData.vertLine.y1"
                            :x2="yBlockData.vertLine.x2"
                            :y2="yBlockData.vertLine.y2"
                            class="vertical-reference-line"
                        />

                        <!-- Single arc from vertical to horizontal -->
                        <path :d="yBlockData.arcPath" class="angle-arc" />
                        <text
                            :x="yBlockData.arc1LabelPos.x"
                            :y="yBlockData.arc1LabelPos.y"
                            class="angle-label"
                            x-text="(angleY?.toFixed(4) ?? '--') + '°'"
                        ></text>
                        <text
                            :x="yBlockData.arc2LabelPos.x"
                            :y="yBlockData.arc2LabelPos.y"
                            class="angle-label-complement"
                            x-text="(complementaryAngleY?.toFixed(4) ?? '--') + '°'"
                        ></text>

                        <!-- Y Label -->
                        <text x="420" y="270" class="block-axis-label">Y</text>
                    </g>
                </g>
            </svg>
        </section>

        <!-- Printer Info Modal -->
        <div
            x-show="showPrinterModal && selectedPrinter"
            x-cloak
            class="modal-backdrop"
            @click.self="showPrinterModal = false"
            @keydown.escape.window="showPrinterModal = false"
            role="dialog"
            aria-modal="true"
            aria-labelledby="modal-title"
        >
            <div class="modal">
                <header class="modal-header">
                    <h3 id="modal-title" x-text="selectedPrinter?.manufacturer + ' ' + selectedPrinter?.model"></h3>
                    <button @click="showPrinterModal = false" class="modal-close" aria-label="Close">&times;</button>
                </header>
                <div class="modal-body">
                    <dl class="printer-specs">
                        <div class="spec-row">
                            <dt>Screen Resolution</dt>
                            <dd x-text="selectedPrinter?.resolutionX + ' × ' + selectedPrinter?.resolutionY + ' px'"></dd>
                        </div>
                        <div class="spec-row">
                            <dt>Build Volume</dt>
                            <dd x-text="selectedPrinter?.sizeX + ' × ' + selectedPrinter?.sizeY + ' × ' + selectedPrinter?.sizeZ + ' mm'"></dd>
                        </div>
                        <div class="spec-row">
                            <dt>Pixel Size (XY)</dt>
                            <dd x-text="selectedPrinter?.pixelX === selectedPrinter?.pixelY ? selectedPrinter?.pixelX + ' μm' : selectedPrinter?.pixelX + ' × ' + selectedPrinter?.pixelY + ' μm'"></dd>
                        </div>
                        <div class="spec-row">
                            <dt>Z Resolution</dt>
                            <dd x-text="selectedPrinter?.zRes + ' μm'"></dd>
                        </div>
                        <div class="spec-row" x-show="selectedPrinter?.year">
                            <dt>Release Year</dt>
                            <dd x-text="selectedPrinter?.year"></dd>
                        </div>
                    </dl>
                </div>
            </div>
        </div>

        <footer class="site-footer">
            <p>Your printer is missing? <a href="https://github.com/rufinus/sla-angle-calculator" target="_blank" rel="noopener">Pull requests welcome!</a></p>
            <a href="https://github.com/rufinus/sla-angle-calculator" target="_blank" rel="noopener" aria-label="View on GitHub">
                <svg class="github-icon" viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
                    <path fill="currentColor" d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                </svg>
            </a>
        </footer>

    </main>
</body>
</html>
